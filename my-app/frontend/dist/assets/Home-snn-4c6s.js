import{d as it,r as u,b as P,t as dt,U as ct,c as x,o as y,a,I as ut,R as r,J as n,al as R,az as vt,D as mt,P as C,E as q,O as k,Q as gt,a6 as pt}from"./vue-kqFMiSVm.js";import{a as U}from"./utils-NIGUFBhG.js";import{H as ft,C as ht}from"./ChartSkeleton-rVH1wQtc.js";import{E as I}from"./element-plus-CcUPQmts.js";import{_ as yt}from"./index-Cl_tPIte.js";import"./highcharts-DSb220Oi.js";const _t={class:"home-container"},wt={class:"stats-row"},Dt={class:"stat-content"},St={class:"circle-progress"},bt={viewBox:"0 0 200 200",class:"progress-svg"},xt={class:"circle-text"},Ct={class:"circle-value"},kt={class:"mqtt-status-badge"},It={class:"status-text"},$t={class:"stat-content"},Mt={class:"stat-value"},Et={class:"refresh-countdown"},Bt={class:"stat-content"},Tt={class:"day-selector"},Vt={class:"button-group"},Ft={key:0,class:"charts-container"},Ht={key:1,class:"charts-container"},At={class:"logs-dialog-content"},Lt={class:"logs-container"},Rt={class:"dialog-footer"},qt={class:"export-dialog-content"},Ut={class:"dialog-footer"},Yt=it({__name:"Home",setup(zt){const X=vt(),Y=u(!1),T=u((()=>{const e=localStorage.getItem("selectedDay");if(e){const t=parseInt(e);return[1,7].includes(t)?t:1}return 1})()),Q=u(""),z=u([]),V=new Map,$=u(300),F=u("stopped");let _=null,w=null;const W=P(()=>z.value.filter(e=>e.voltage_data.length===0?!1:e.voltage_data[e.voltage_data.length-1].avg_voltage>=100).length),H=P(()=>z.value.filter(e=>e.voltage_data.length>0)),Z=P(()=>{const e=Math.floor($.value/60),t=$.value%60;return`${e}:${t.toString().padStart(2,"0")}`}),O=async()=>{Y.value=!0;try{const e=await U.get("/api/home/overview",{params:{day:T.value}});Q.value=e.data.query_time,z.value=e.data.devices,setTimeout(()=>{rt()},100)}catch(e){console.error("获取数据失败:",e),I.error("获取数据失败，请稍后重试")}finally{Y.value=!1}},N=async()=>{try{const e=await U.get("/api/mqtt/status");F.value=e.data.connected?"running":"stopped"}catch(e){console.error("获取MQTT状态失败:",e),F.value="stopped"}},tt=()=>{_&&clearInterval(_),w&&clearInterval(w),_=setInterval(()=>{O(),N(),$.value=300},3e5),w=setInterval(()=>{$.value>0&&$.value--},1e3);const e=setInterval(()=>{N()},6e4);window.__mqttStatusInterval=e},et=()=>{_&&(clearInterval(_),_=null),w&&(clearInterval(w),w=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},at=()=>{X.push("/charts")},M=u(!1),A=u([]);let m=null;const j=async()=>{try{const e=await U.get("/api/mqtt/logs");A.value=e.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(e){console.error("获取MQTT日志失败:",e),A.value=["[系统] 获取日志失败"]}},st=()=>{j(),M.value=!0,m&&clearInterval(m),m=setInterval(()=>{M.value&&j()},2e3)},ot=()=>{M.value=!1,m&&(clearInterval(m),m=null)},E=u(!1),B=u(!1),J=()=>{const e=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,e]},D=u(J()),nt=()=>{D.value=J(),E.value=!0},lt=async()=>{if(!D.value||D.value.length!==2){I.warning("请选择起始和截止时间");return}const[e,t]=D.value,i=l=>{const s=l.getFullYear(),v=String(l.getMonth()+1).padStart(2,"0"),o=String(l.getDate()).padStart(2,"0"),c=String(l.getHours()).padStart(2,"0"),g=String(l.getMinutes()).padStart(2,"0"),p=String(l.getSeconds()).padStart(2,"0");return`${s}-${v}-${o} ${c}:${g}:${p}`},d=i(e),f=i(t);B.value=!0;try{const l=await U.get("/api/home/export",{params:{start_datetime:d,end_datetime:f},responseType:"blob"}),s=new Blob([l.data],{type:"text/csv;charset=utf-8;"}),v=window.URL.createObjectURL(s),o=document.createElement("a");o.href=v;const c=l.headers["content-disposition"];let g=`设备数据_${d.replace(/[:\s-]/g,"")}_${f.replace(/[:\s-]/g,"")}.csv`;if(c){const p=c.match(/filename=(.+)/);p&&p[1]&&(g=p[1])}o.download=g,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(v),I.success("数据导出成功"),E.value=!1}catch(l){if(console.error("导出数据失败:",l),l.response&&l.response.data){const s=new FileReader;s.onload=()=>{try{const v=JSON.parse(s.result);I.error(v.detail||"导出数据失败")}catch{I.error("导出数据失败，请稍后重试")}},s.readAsText(l.response.data)}else I.error("导出数据失败，请稍后重试")}finally{B.value=!1}},G=e=>{T.value=e,localStorage.setItem("selectedDay",e.toString()),O()},rt=()=>{if(H.value.length===0)return;const e="combined-chart";if(!document.getElementById(e))return;if(V.has(e)){const o=V.get(e);o&&o.destroy(),V.delete(e)}const i=new Set;H.value.forEach(o=>{o.voltage_data.forEach(c=>{i.add(`${c.date} ${c.time}`)})});const d=Array.from(i).sort(),f=d.map(o=>new Date(o).getTime()),l=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#EFC94C","#17BECF","#4C72B0","#DD8452","#55A868","#C44E52","#8172B3","#937860","#64B5CD","#E99675","#97BBCD","#B5BD89","#FF6F61","#6A5ACD"],s=H.value.map((o,c)=>{const g=new Map;o.voltage_data.forEach(h=>{const S=`${h.date} ${h.time}`;g.set(S,h.avg_voltage)});const p=d.map((h,S)=>{const L=g.get(h);return L!==void 0?[f[S],L]:[f[S],null]});return{name:o.machine_name,data:p,color:l[c%l.length],type:"line",marker:{enabled:!1}}}),v=ft.chart(e,{chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},labels:{rotation:0,align:"center"},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const o=new Date(this.x),c=o.getFullYear(),g=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),h=String(o.getHours()).padStart(2,"0"),S=String(o.getMinutes()).padStart(2,"0"),L=String(o.getSeconds()).padStart(2,"0");let K='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${c}-${g}-${p} ${h}:${S}:${L}`+"</div>";return this.points?.forEach(b=>{b.y!==null&&b.y!==void 0&&(K+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+b.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+b.color+'; font-weight: 700;">'+b.series.name+": "+b.y.toFixed(2)+" mV</span></div>")}),K}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom"},series:s,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}});V.set(e,v)};return dt(()=>{O(),N(),tt()}),ct(()=>{et(),m&&(clearInterval(m),m=null)}),(e,t)=>{const i=R("el-card"),d=R("el-button"),f=R("el-dialog"),l=R("el-date-picker");return y(),x("div",_t,[a("div",wt,[r(i,{class:"stat-card"},{header:n(()=>[...t[7]||(t[7]=[a("div",{class:"card-header"},"正在运行的设备",-1)])]),default:n(()=>[a("div",Dt,[a("div",St,[(y(),x("svg",bt,[t[8]||(t[8]=a("defs",null,[a("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[a("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),a("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[9]||(t[9]=a("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),a("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:mt({strokeDashoffset:502.4-502.4*W.value/15})},null,4)])),a("div",xt,[a("div",Ct,C(W.value),1),t[10]||(t[10]=a("div",{class:"circle-total"},"/15",-1))])]),a("div",kt,[a("div",{class:q(["status-indicator",F.value]),onClick:st,style:{cursor:"pointer"}},[t[11]||(t[11]=a("span",{class:"status-dot"},null,-1)),a("span",It,C(F.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[12]||(t[12]=[a("div",{class:"card-header"},"最近查询时间",-1)])]),default:n(()=>[a("div",$t,[a("div",Mt,C(Q.value),1),a("div",Et,"自动刷新倒计时："+C(Z.value),1)])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[13]||(t[13]=[a("div",{class:"card-header"},"图表显示时间",-1)])]),default:n(()=>[a("div",Bt,[a("div",Tt,[a("button",{class:q(["day-btn",{active:T.value===1}]),onClick:t[0]||(t[0]=s=>G(1))}," 最近1天 ",2),a("button",{class:q(["day-btn",{active:T.value===7}]),onClick:t[1]||(t[1]=s=>G(7))}," 最近一周 ",2)])])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[14]||(t[14]=[a("div",{class:"card-header"},"其他",-1)])]),default:n(()=>[a("div",Vt,[r(d,{type:"success",class:"action-btn",onClick:nt},{default:n(()=>[...t[15]||(t[15]=[a("span",{class:"btn-icon"},"📥",-1),k(" 导出数据 ",-1)])]),_:1}),r(d,{type:"primary",class:"action-btn",onClick:at},{default:n(()=>[...t[16]||(t[16]=[a("span",{class:"btn-icon"},"📋",-1),k(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),Y.value?(y(),x("div",Ft,[r(i,{class:"chart-card"},{header:n(()=>[...t[17]||(t[17]=[a("div",{class:"chart-title"},"总看板",-1)])]),default:n(()=>[r(ht)]),_:1})])):H.value.length===0?(y(),x("div",Ht,[r(i,{class:"no-data-card"},{default:n(()=>[...t[18]||(t[18]=[a("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(y(),ut(i,{key:2,class:"chart-card"},{header:n(()=>[...t[19]||(t[19]=[a("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:n(()=>[...t[20]||(t[20]=[a("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),r(f,{modelValue:M.value,"onUpdate:modelValue":t[3]||(t[3]=s=>M.value=s),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:n(()=>[a("div",Rt,[r(d,{onClick:t[2]||(t[2]=s=>A.value=[])},{default:n(()=>[...t[21]||(t[21]=[k("清除日志",-1)])]),_:1}),r(d,{type:"primary",onClick:ot},{default:n(()=>[...t[22]||(t[22]=[k("关闭",-1)])]),_:1})])]),default:n(()=>[a("div",At,[a("div",Lt,[(y(!0),x(gt,null,pt(A.value,(s,v)=>(y(),x("div",{key:v,class:q(["log-line",{"log-error":s.includes("[错误]"),"log-warning":s.includes("[警告]"),"log-success":s.includes("[成功]")}])},C(s),3))),128))])])]),_:1},8,["modelValue"]),r(f,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=s=>E.value=s),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:n(()=>[a("div",Ut,[r(d,{onClick:t[5]||(t[5]=s=>E.value=!1),disabled:B.value},{default:n(()=>[...t[24]||(t[24]=[k("取消",-1)])]),_:1},8,["disabled"]),r(d,{type:"primary",onClick:lt,loading:B.value},{default:n(()=>[k(C(B.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:n(()=>[a("div",qt,[t[23]||(t[23]=a("div",{class:"date-range-label"},"选择时间范围",-1)),r(l,{modelValue:D.value,"onUpdate:modelValue":t[4]||(t[4]=s=>D.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),Kt=yt(Yt,[["__scopeId","data-v-980726ea"]]);export{Kt as default};
