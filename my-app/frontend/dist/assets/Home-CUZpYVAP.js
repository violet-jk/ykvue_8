import{d as dt,r as d,b as Q,w as ut,t as vt,U as mt,c as C,o as y,a,I as gt,R as r,J as l,al as q,az as pt,D as ft,P as x,E as U,O as k,Q as ht,a6 as yt}from"./vue-kqFMiSVm.js";import{a as Y}from"./utils-NIGUFBhG.js";import{H as _t,C as wt}from"./ChartSkeleton-CiOqn7bp.js";import{E as I}from"./element-plus-CcUPQmts.js";import{_ as Dt}from"./index-CG3nJiMN.js";import"./highcharts-DSb220Oi.js";const St={class:"home-container"},bt={class:"stats-row"},Ct={class:"stat-content"},xt={class:"circle-progress"},kt={viewBox:"0 0 200 200",class:"progress-svg"},It={class:"circle-text"},$t={class:"circle-value"},Mt={class:"mqtt-status-badge"},Tt={class:"status-text"},Bt={class:"stat-content"},Et={class:"stat-value"},Vt={class:"refresh-countdown"},Ft={class:"stat-content"},Ht={class:"day-selector"},Rt={class:"button-group"},Lt={key:0,class:"charts-container"},At={key:1,class:"charts-container"},qt={class:"logs-dialog-content"},Ut={class:"dialog-footer"},Yt={class:"export-dialog-content"},zt={class:"dialog-footer"},Ot=dt({__name:"Home",setup(Nt){const Z=pt(),z=d(!1),F=d((()=>{const e=localStorage.getItem("selectedDay");if(e){const t=parseInt(e);return[1,7].includes(t)?t:1}return 1})()),W=d(""),O=d([]),H=new Map,$=d(300),R=d("stopped");let _=null,w=null;const j=Q(()=>O.value.filter(e=>e.voltage_data.length===0?!1:e.voltage_data[e.voltage_data.length-1].avg_voltage>=100).length),L=Q(()=>O.value.filter(e=>e.voltage_data.length>0)),tt=Q(()=>{const e=Math.floor($.value/60),t=$.value%60;return`${e}:${t.toString().padStart(2,"0")}`}),N=async()=>{z.value=!0;try{const e=await Y.get("/api/home/overview",{params:{day:F.value}});W.value=e.data.query_time,O.value=e.data.devices,setTimeout(()=>{ct()},100)}catch(e){console.error("获取数据失败:",e),I.error("获取数据失败，请稍后重试")}finally{z.value=!1}},P=async()=>{try{const e=await Y.get("/api/mqtt/status");R.value=e.data.connected?"running":"stopped"}catch(e){console.error("获取MQTT状态失败:",e),R.value="stopped"}},et=()=>{_&&clearInterval(_),w&&clearInterval(w),_=setInterval(()=>{N(),P(),$.value=300},3e5),w=setInterval(()=>{$.value>0&&$.value--},1e3);const e=setInterval(()=>{P()},6e4);window.__mqttStatusInterval=e},at=()=>{_&&(clearInterval(_),_=null),w&&(clearInterval(w),w=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},st=()=>{Z.push("/charts")},M=d(!1),T=d(null),B=d([]);let m=null;const ot=()=>{T.value&&setTimeout(()=>{T.value&&(T.value.scrollTop=T.value.scrollHeight)},0)};ut(B,()=>{ot()},{deep:!0});const J=async()=>{try{const e=await Y.get("/api/mqtt/logs");B.value=e.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(e){console.error("获取MQTT日志失败:",e),B.value=["[系统] 获取日志失败"]}},lt=()=>{J(),M.value=!0,m&&clearInterval(m),m=setInterval(()=>{M.value&&J()},2e3)},nt=()=>{M.value=!1,m&&(clearInterval(m),m=null)},E=d(!1),V=d(!1),G=()=>{const e=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,e]},D=d(G()),rt=()=>{D.value=G(),E.value=!0},it=async()=>{if(!D.value||D.value.length!==2){I.warning("请选择起始和截止时间");return}const[e,t]=D.value,i=n=>{const s=n.getFullYear(),v=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0"),u=String(n.getHours()).padStart(2,"0"),g=String(n.getMinutes()).padStart(2,"0"),p=String(n.getSeconds()).padStart(2,"0");return`${s}-${v}-${o} ${u}:${g}:${p}`},c=i(e),f=i(t);V.value=!0;try{const n=await Y.get("/api/home/export",{params:{start_datetime:c,end_datetime:f},responseType:"blob"}),s=new Blob([n.data],{type:"text/csv;charset=utf-8;"}),v=window.URL.createObjectURL(s),o=document.createElement("a");o.href=v;const u=n.headers["content-disposition"];let g=`设备数据_${c.replace(/[:\s-]/g,"")}_${f.replace(/[:\s-]/g,"")}.csv`;if(u){const p=u.match(/filename=(.+)/);p&&p[1]&&(g=p[1])}o.download=g,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(v),I.success("数据导出成功"),E.value=!1}catch(n){if(console.error("导出数据失败:",n),n.response&&n.response.data){const s=new FileReader;s.onload=()=>{try{const v=JSON.parse(s.result);I.error(v.detail||"导出数据失败")}catch{I.error("导出数据失败，请稍后重试")}},s.readAsText(n.response.data)}else I.error("导出数据失败，请稍后重试")}finally{V.value=!1}},K=e=>{F.value=e,localStorage.setItem("selectedDay",e.toString()),N()},ct=()=>{if(L.value.length===0)return;const e="combined-chart";if(!document.getElementById(e))return;if(H.has(e)){const o=H.get(e);o&&o.destroy(),H.delete(e)}const i=new Set;L.value.forEach(o=>{o.voltage_data.forEach(u=>{i.add(`${u.date} ${u.time}`)})});const c=Array.from(i).sort(),f=c.map(o=>new Date(o).getTime()),n=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#EFC94C","#17BECF","#4C72B0","#DD8452","#55A868","#C44E52","#8172B3","#937860","#64B5CD","#E99675","#97BBCD","#B5BD89","#FF6F61","#6A5ACD"],s=L.value.map((o,u)=>{const g=new Map;o.voltage_data.forEach(h=>{const S=`${h.date} ${h.time}`;g.set(S,h.avg_voltage)});const p=c.map((h,S)=>{const A=g.get(h);return A!==void 0?[f[S],A]:[f[S],null]});return{name:o.machine_name,data:p,color:n[u%n.length],type:"line",marker:{enabled:!1}}}),v=_t.chart(e,{chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},labels:{rotation:0,align:"center"},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const o=new Date(this.x),u=o.getFullYear(),g=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),h=String(o.getHours()).padStart(2,"0"),S=String(o.getMinutes()).padStart(2,"0"),A=String(o.getSeconds()).padStart(2,"0");let X='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${u}-${g}-${p} ${h}:${S}:${A}`+"</div>";return this.points?.forEach(b=>{b.y!==null&&b.y!==void 0&&(X+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+b.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+b.color+'; font-weight: 700;">'+b.series.name+": "+b.y.toFixed(2)+" mV</span></div>")}),X}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom"},series:s,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}});H.set(e,v)};return vt(()=>{N(),P(),et()}),mt(()=>{at(),m&&(clearInterval(m),m=null)}),(e,t)=>{const i=q("el-card"),c=q("el-button"),f=q("el-dialog"),n=q("el-date-picker");return y(),C("div",St,[a("div",bt,[r(i,{class:"stat-card"},{header:l(()=>[...t[7]||(t[7]=[a("div",{class:"card-header"},"正在运行的设备",-1)])]),default:l(()=>[a("div",Ct,[a("div",xt,[(y(),C("svg",kt,[t[8]||(t[8]=a("defs",null,[a("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[a("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),a("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[9]||(t[9]=a("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),a("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:ft({strokeDashoffset:502.4-502.4*j.value/15})},null,4)])),a("div",It,[a("div",$t,x(j.value),1),t[10]||(t[10]=a("div",{class:"circle-total"},"/15",-1))])]),a("div",Mt,[a("div",{class:U(["status-indicator",R.value]),onClick:lt,style:{cursor:"pointer"}},[t[11]||(t[11]=a("span",{class:"status-dot"},null,-1)),a("span",Tt,x(R.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),r(i,{class:"stat-card"},{header:l(()=>[...t[12]||(t[12]=[a("div",{class:"card-header"},"最近查询时间",-1)])]),default:l(()=>[a("div",Bt,[a("div",Et,x(W.value),1),a("div",Vt,"自动刷新倒计时："+x(tt.value),1)])]),_:1}),r(i,{class:"stat-card"},{header:l(()=>[...t[13]||(t[13]=[a("div",{class:"card-header"},"图表显示时间",-1)])]),default:l(()=>[a("div",Ft,[a("div",Ht,[a("button",{class:U(["day-btn",{active:F.value===1}]),onClick:t[0]||(t[0]=s=>K(1))}," 最近1天 ",2),a("button",{class:U(["day-btn",{active:F.value===7}]),onClick:t[1]||(t[1]=s=>K(7))}," 最近一周 ",2)])])]),_:1}),r(i,{class:"stat-card"},{header:l(()=>[...t[14]||(t[14]=[a("div",{class:"card-header"},"其他",-1)])]),default:l(()=>[a("div",Rt,[r(c,{type:"success",class:"action-btn",onClick:rt},{default:l(()=>[...t[15]||(t[15]=[a("span",{class:"btn-icon"},"📥",-1),k(" 导出数据 ",-1)])]),_:1}),r(c,{type:"primary",class:"action-btn",onClick:st},{default:l(()=>[...t[16]||(t[16]=[a("span",{class:"btn-icon"},"📋",-1),k(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),z.value?(y(),C("div",Lt,[r(i,{class:"chart-card"},{header:l(()=>[...t[17]||(t[17]=[a("div",{class:"chart-title"},"总看板",-1)])]),default:l(()=>[r(wt)]),_:1})])):L.value.length===0?(y(),C("div",At,[r(i,{class:"no-data-card"},{default:l(()=>[...t[18]||(t[18]=[a("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(y(),gt(i,{key:2,class:"chart-card"},{header:l(()=>[...t[19]||(t[19]=[a("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:l(()=>[...t[20]||(t[20]=[a("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),r(f,{modelValue:M.value,"onUpdate:modelValue":t[3]||(t[3]=s=>M.value=s),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:l(()=>[a("div",Ut,[r(c,{onClick:t[2]||(t[2]=s=>B.value=[])},{default:l(()=>[...t[21]||(t[21]=[k("清除日志",-1)])]),_:1}),r(c,{type:"primary",onClick:nt},{default:l(()=>[...t[22]||(t[22]=[k("关闭",-1)])]),_:1})])]),default:l(()=>[a("div",qt,[a("div",{class:"logs-container",ref_key:"logsContainerRef",ref:T},[(y(!0),C(ht,null,yt(B.value,(s,v)=>(y(),C("div",{key:v,class:U(["log-line",{"log-error":s.includes("[错误]"),"log-warning":s.includes("[警告]"),"log-success":s.includes("[成功]")}])},x(s),3))),128))],512)])]),_:1},8,["modelValue"]),r(f,{modelValue:E.value,"onUpdate:modelValue":t[6]||(t[6]=s=>E.value=s),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:l(()=>[a("div",zt,[r(c,{onClick:t[5]||(t[5]=s=>E.value=!1),disabled:V.value},{default:l(()=>[...t[24]||(t[24]=[k("取消",-1)])]),_:1},8,["disabled"]),r(c,{type:"primary",onClick:it,loading:V.value},{default:l(()=>[k(x(V.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:l(()=>[a("div",Yt,[t[23]||(t[23]=a("div",{class:"date-range-label"},"选择时间范围",-1)),r(n,{modelValue:D.value,"onUpdate:modelValue":t[4]||(t[4]=s=>D.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),Zt=Dt(Ot,[["__scopeId","data-v-121810f1"]]);export{Zt as default};
