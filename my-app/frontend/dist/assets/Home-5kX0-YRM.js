import{d as ut,r as d,b as Q,w as vt,t as gt,U as mt,c as C,o as y,a,I as pt,R as r,J as n,al as q,az as ft,D as ht,P as x,E as U,O as k,Q as yt,a6 as _t,v as wt}from"./vue-kqFMiSVm.js";import{a as Y}from"./utils-NIGUFBhG.js";import{H as bt,C as Dt}from"./ChartSkeleton-Cw6v8A65.js";import{E as $}from"./element-plus-CcUPQmts.js";import{_ as St}from"./index-D_GrNYVa.js";import"./highcharts-DSb220Oi.js";const Ct={class:"home-container"},xt={class:"stats-row"},kt={class:"stat-content"},$t={class:"circle-progress"},It={viewBox:"0 0 200 200",class:"progress-svg"},Mt={class:"circle-text"},Tt={class:"circle-value"},Bt={class:"mqtt-status-badge"},Et={class:"status-text"},Vt={class:"stat-content"},Ft={class:"stat-value"},Ht={class:"refresh-countdown"},Lt={class:"stat-content"},Rt={class:"day-selector"},At={class:"button-group"},qt={key:0,class:"charts-container"},Ut={key:1,class:"charts-container"},Yt={class:"logs-dialog-content"},zt={class:"dialog-footer"},Ot={class:"export-dialog-content"},Nt={class:"dialog-footer"},Pt=ut({__name:"Home",setup(Qt){const tt=ft(),z=d(!1),V=d((()=>{const e=localStorage.getItem("selectedDay");if(e){const t=parseInt(e);return[1,7].includes(t)?t:1}return 1})()),W=d(""),O=d([]),F=new Map,I=d(300),H=d("stopped");let _=null,w=null;const j=Q(()=>O.value.filter(e=>e.voltage_data.length===0?!1:e.voltage_data[e.voltage_data.length-1].avg_voltage>=100).length),L=Q(()=>O.value.filter(e=>e.voltage_data.length>0)),et=Q(()=>{const e=Math.floor(I.value/60),t=I.value%60;return`${e}:${t.toString().padStart(2,"0")}`}),N=async()=>{z.value=!0;try{const e=await Y.get("/api/home/overview",{params:{day:V.value}});W.value=e.data.query_time,O.value=e.data.devices,setTimeout(()=>{dt()},100)}catch(e){console.error("获取数据失败:",e),$.error("获取数据失败，请稍后重试")}finally{z.value=!1}},P=async()=>{try{const e=await Y.get("/api/mqtt/status");H.value=e.data.connected?"running":"stopped"}catch(e){console.error("获取MQTT状态失败:",e),H.value="stopped"}},at=()=>{_&&clearInterval(_),w&&clearInterval(w),_=setInterval(()=>{N(),P(),I.value=300},3e5),w=setInterval(()=>{I.value>0&&I.value--},1e3);const e=setInterval(()=>{P()},6e4);window.__mqttStatusInterval=e},st=()=>{_&&(clearInterval(_),_=null),w&&(clearInterval(w),w=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},ot=()=>{tt.push("/charts")},M=d(!1),R=d(null),T=d([]);let g=null;const nt=async()=>{await wt(),R.value&&(R.value.scrollTop=R.value.scrollHeight)};let J="";vt(T,e=>{const t=e.length>0?e[e.length-1]:"";t&&t!==J&&(console.log("[日志] 检测到新日志，自动滚动到底部"),console.log(`[日志] 最新日志: ${t.substring(0,80)}...`),nt()),J=t});const G=async()=>{try{const e=await Y.get("/api/mqtt/logs");T.value=e.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(e){console.error("获取MQTT日志失败:",e),T.value=["[系统] 获取日志失败"]}},lt=()=>{G(),M.value=!0,g&&clearInterval(g),g=setInterval(()=>{M.value&&G()},2e3)},rt=()=>{M.value=!1,g&&(clearInterval(g),g=null)},B=d(!1),E=d(!1),K=()=>{const e=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,e]},b=d(K()),it=()=>{b.value=K(),B.value=!0},ct=async()=>{if(!b.value||b.value.length!==2){$.warning("请选择起始和截止时间");return}const[e,t]=b.value,i=l=>{const s=l.getFullYear(),v=String(l.getMonth()+1).padStart(2,"0"),o=String(l.getDate()).padStart(2,"0"),u=String(l.getHours()).padStart(2,"0"),m=String(l.getMinutes()).padStart(2,"0"),p=String(l.getSeconds()).padStart(2,"0");return`${s}-${v}-${o} ${u}:${m}:${p}`},c=i(e),f=i(t);E.value=!0;try{const l=await Y.get("/api/home/export",{params:{start_datetime:c,end_datetime:f},responseType:"blob"}),s=new Blob([l.data],{type:"text/csv;charset=utf-8;"}),v=window.URL.createObjectURL(s),o=document.createElement("a");o.href=v;const u=l.headers["content-disposition"];let m=`设备数据_${c.replace(/[:\s-]/g,"")}_${f.replace(/[:\s-]/g,"")}.csv`;if(u){const p=u.match(/filename=(.+)/);p&&p[1]&&(m=p[1])}o.download=m,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(v),$.success("数据导出成功"),B.value=!1}catch(l){if(console.error("导出数据失败:",l),l.response&&l.response.data){const s=new FileReader;s.onload=()=>{try{const v=JSON.parse(s.result);$.error(v.detail||"导出数据失败")}catch{$.error("导出数据失败，请稍后重试")}},s.readAsText(l.response.data)}else $.error("导出数据失败，请稍后重试")}finally{E.value=!1}},X=e=>{V.value=e,localStorage.setItem("selectedDay",e.toString()),N()},dt=()=>{if(L.value.length===0)return;const e="combined-chart";if(!document.getElementById(e))return;if(F.has(e)){const o=F.get(e);o&&o.destroy(),F.delete(e)}const i=new Set;L.value.forEach(o=>{o.voltage_data.forEach(u=>{i.add(`${u.date} ${u.time}`)})});const c=Array.from(i).sort(),f=c.map(o=>new Date(o).getTime()),l=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#EFC94C","#17BECF","#4C72B0","#DD8452","#55A868","#C44E52","#8172B3","#937860","#64B5CD","#E99675","#97BBCD","#B5BD89","#FF6F61","#6A5ACD"],s=L.value.map((o,u)=>{const m=new Map;o.voltage_data.forEach(h=>{const D=`${h.date} ${h.time}`;m.set(D,h.avg_voltage)});const p=c.map((h,D)=>{const A=m.get(h);return A!==void 0?[f[D],A]:[f[D],null]});return{name:o.machine_name,data:p,color:l[u%l.length],type:"line",marker:{enabled:!1}}}),v=bt.chart(e,{chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},labels:{rotation:0,align:"center"},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const o=new Date(this.x),u=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),p=String(o.getDate()).padStart(2,"0"),h=String(o.getHours()).padStart(2,"0"),D=String(o.getMinutes()).padStart(2,"0"),A=String(o.getSeconds()).padStart(2,"0");let Z='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${u}-${m}-${p} ${h}:${D}:${A}`+"</div>";return this.points?.forEach(S=>{S.y!==null&&S.y!==void 0&&(Z+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+S.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+S.color+'; font-weight: 700;">'+S.series.name+": "+S.y.toFixed(2)+" mV</span></div>")}),Z}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom"},series:s,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}});F.set(e,v)};return gt(()=>{N(),P(),at()}),mt(()=>{st(),g&&(clearInterval(g),g=null)}),(e,t)=>{const i=q("el-card"),c=q("el-button"),f=q("el-dialog"),l=q("el-date-picker");return y(),C("div",Ct,[a("div",xt,[r(i,{class:"stat-card"},{header:n(()=>[...t[7]||(t[7]=[a("div",{class:"card-header"},"正在运行的设备",-1)])]),default:n(()=>[a("div",kt,[a("div",$t,[(y(),C("svg",It,[t[8]||(t[8]=a("defs",null,[a("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[a("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),a("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[9]||(t[9]=a("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),a("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:ht({strokeDashoffset:502.4-502.4*j.value/15})},null,4)])),a("div",Mt,[a("div",Tt,x(j.value),1),t[10]||(t[10]=a("div",{class:"circle-total"},"/15",-1))])]),a("div",Bt,[a("div",{class:U(["status-indicator",H.value]),onClick:lt,style:{cursor:"pointer"}},[t[11]||(t[11]=a("span",{class:"status-dot"},null,-1)),a("span",Et,x(H.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[12]||(t[12]=[a("div",{class:"card-header"},"最近查询时间",-1)])]),default:n(()=>[a("div",Vt,[a("div",Ft,x(W.value),1),a("div",Ht,"自动刷新倒计时："+x(et.value),1)])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[13]||(t[13]=[a("div",{class:"card-header"},"图表显示时间",-1)])]),default:n(()=>[a("div",Lt,[a("div",Rt,[a("button",{class:U(["day-btn",{active:V.value===1}]),onClick:t[0]||(t[0]=s=>X(1))}," 最近1天 ",2),a("button",{class:U(["day-btn",{active:V.value===7}]),onClick:t[1]||(t[1]=s=>X(7))}," 最近一周 ",2)])])]),_:1}),r(i,{class:"stat-card"},{header:n(()=>[...t[14]||(t[14]=[a("div",{class:"card-header"},"其他",-1)])]),default:n(()=>[a("div",At,[r(c,{type:"success",class:"action-btn",onClick:it},{default:n(()=>[...t[15]||(t[15]=[a("span",{class:"btn-icon"},"📥",-1),k(" 导出数据 ",-1)])]),_:1}),r(c,{type:"primary",class:"action-btn",onClick:ot},{default:n(()=>[...t[16]||(t[16]=[a("span",{class:"btn-icon"},"📋",-1),k(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),z.value?(y(),C("div",qt,[r(i,{class:"chart-card"},{header:n(()=>[...t[17]||(t[17]=[a("div",{class:"chart-title"},"总看板",-1)])]),default:n(()=>[r(Dt)]),_:1})])):L.value.length===0?(y(),C("div",Ut,[r(i,{class:"no-data-card"},{default:n(()=>[...t[18]||(t[18]=[a("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(y(),pt(i,{key:2,class:"chart-card"},{header:n(()=>[...t[19]||(t[19]=[a("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:n(()=>[...t[20]||(t[20]=[a("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),r(f,{modelValue:M.value,"onUpdate:modelValue":t[3]||(t[3]=s=>M.value=s),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:n(()=>[a("div",zt,[r(c,{onClick:t[2]||(t[2]=s=>T.value=[])},{default:n(()=>[...t[21]||(t[21]=[k("清除日志",-1)])]),_:1}),r(c,{type:"primary",onClick:rt},{default:n(()=>[...t[22]||(t[22]=[k("关闭",-1)])]),_:1})])]),default:n(()=>[a("div",Yt,[a("div",{class:"logs-container",ref_key:"logsContainerRef",ref:R},[(y(!0),C(yt,null,_t(T.value,(s,v)=>(y(),C("div",{key:v,class:U(["log-line",{"log-error":s.includes("[错误]"),"log-warning":s.includes("[警告]"),"log-success":s.includes("[成功]")}])},x(s),3))),128))],512)])]),_:1},8,["modelValue"]),r(f,{modelValue:B.value,"onUpdate:modelValue":t[6]||(t[6]=s=>B.value=s),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:n(()=>[a("div",Nt,[r(c,{onClick:t[5]||(t[5]=s=>B.value=!1),disabled:E.value},{default:n(()=>[...t[24]||(t[24]=[k("取消",-1)])]),_:1},8,["disabled"]),r(c,{type:"primary",onClick:ct,loading:E.value},{default:n(()=>[k(x(E.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:n(()=>[a("div",Ot,[t[23]||(t[23]=a("div",{class:"date-range-label"},"选择时间范围",-1)),r(l,{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=s=>b.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),ee=St(Pt,[["__scopeId","data-v-4b65d7f8"]]);export{ee as default};
