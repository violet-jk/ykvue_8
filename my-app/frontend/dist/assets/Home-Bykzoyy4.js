import{d as it,r as d,b as W,w as ct,t as dt,U as ut,c as w,o as h,a,I as vt,R as n,J as l,al as E,az as mt,D as gt,P as D,E as L,O as x,Q as pt,a6 as ft,v as ht}from"./vue-kqFMiSVm.js";import{a as F}from"./utils-NIGUFBhG.js";import{H as yt,C as _t}from"./ChartSkeleton-BT74g9AP.js";import{E as C}from"./element-plus-CcUPQmts.js";import{_ as bt}from"./index-qCoNVqoY.js";import"./highcharts-DSb220Oi.js";const St={class:"home-container"},wt={class:"stats-row"},Dt={class:"stat-content"},xt={class:"circle-progress"},Ct={viewBox:"0 0 200 200",class:"progress-svg"},kt={class:"circle-text"},It={class:"circle-value"},$t={class:"mqtt-status-badge"},Mt={class:"status-text"},Tt={class:"stat-content"},Ht={class:"stat-value"},Vt={class:"refresh-countdown"},Bt={class:"stat-content"},Rt={class:"day-selector"},Et={class:"button-group"},Lt={key:0,class:"charts-container"},Ft={key:1,class:"charts-container"},qt={class:"logs-dialog-content"},At={class:"dialog-footer"},Ut={class:"export-dialog-content"},zt={class:"dialog-footer"},Yt=it({__name:"Home",setup(Wt){const K=mt(),q=d(!1),H=d((()=>{const e=localStorage.getItem("selectedDay");if(e){const t=parseInt(e);return[1,7].includes(t)?t:1}return 1})()),O=d(""),A=d([]),V=new Map,k=d(300),B=d("stopped");let y=null,_=null;const N=W(()=>A.value.filter(e=>e.voltage_data.length===0?!1:e.voltage_data[e.voltage_data.length-1].avg_voltage>=100).length),U=W(()=>A.value.filter(e=>e.voltage_data.length>0)),X=W(()=>{const e=Math.floor(k.value/60),t=k.value%60;return`${e}:${t.toString().padStart(2,"0")}`}),z=async()=>{q.value=!0;try{const e=await F.get("/api/home/overview",{params:{day:H.value}});O.value=e.data.query_time,A.value=e.data.devices,setTimeout(()=>{rt()},100)}catch(e){console.error("获取数据失败:",e),C.error("获取数据失败，请稍后重试")}finally{q.value=!1}},Y=async()=>{try{const e=await F.get("/api/mqtt/status");B.value=e.data.connected?"running":"stopped"}catch(e){console.error("获取MQTT状态失败:",e),B.value="stopped"}},Z=()=>{y&&clearInterval(y),_&&clearInterval(_),y=setInterval(()=>{z(),Y(),k.value=300},3e5),_=setInterval(()=>{k.value>0&&k.value--},1e3);const e=setInterval(()=>{Y()},6e4);window.__mqttStatusInterval=e},tt=()=>{y&&(clearInterval(y),y=null),_&&(clearInterval(_),_=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},et=()=>{K.push("/charts")},I=d(!1),R=d(null),$=d([]);let m=null;const at=async()=>{await ht(),R.value&&(R.value.scrollTop=R.value.scrollHeight)};let Q="";ct($,e=>{const t=e.length>0?e[e.length-1]:"";t&&t!==Q&&(console.log("[日志] 检测到新日志，自动滚动到底部"),console.log(`[日志] 最新日志: ${t.substring(0,80)}...`),at()),Q=t});const j=async()=>{try{const e=await F.get("/api/mqtt/logs");$.value=e.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(e){console.error("获取MQTT日志失败:",e),$.value=["[系统] 获取日志失败"]}},st=()=>{j(),I.value=!0,m&&clearInterval(m),m=setInterval(()=>{I.value&&j()},2e3)},ot=()=>{I.value=!1,m&&(clearInterval(m),m=null)},M=d(!1),T=d(!1),J=()=>{const e=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,e]},b=d(J()),lt=()=>{b.value=J(),M.value=!0},nt=async()=>{if(!b.value||b.value.length!==2){C.warning("请选择起始和截止时间");return}const[e,t]=b.value,c=s=>{const o=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0"),v=String(s.getHours()).padStart(2,"0"),g=String(s.getMinutes()).padStart(2,"0"),f=String(s.getSeconds()).padStart(2,"0");return`${o}-${i}-${r} ${v}:${g}:${f}`},u=c(e),p=c(t);T.value=!0;try{const s=await F.get("/api/home/export",{params:{start_datetime:u,end_datetime:p},responseType:"blob"}),o=new Blob([s.data],{type:"text/csv;charset=utf-8;"}),i=window.URL.createObjectURL(o),r=document.createElement("a");r.href=i;const v=s.headers["content-disposition"];let g=`设备数据_${u.replace(/[:\s-]/g,"")}_${p.replace(/[:\s-]/g,"")}.csv`;if(v){const f=v.match(/filename=(.+)/);f&&f[1]&&(g=f[1])}r.download=g,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(i),C.success("数据导出成功"),M.value=!1}catch(s){if(console.error("导出数据失败:",s),s.response&&s.response.data){const o=new FileReader;o.onload=()=>{try{const i=JSON.parse(o.result);C.error(i.detail||"导出数据失败")}catch{C.error("导出数据失败，请稍后重试")}},o.readAsText(s.response.data)}else C.error("导出数据失败，请稍后重试")}finally{T.value=!1}},P=e=>{H.value=e,localStorage.setItem("selectedDay",e.toString()),z()},rt=()=>{if(U.value.length===0)return;const e="combined-chart";if(!document.getElementById(e))return;if(V.has(e)){const s=V.get(e);s&&s.destroy(),V.delete(e)}const c=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#55A868","#C44E52","#8172B3","#937860","#64B5CD","#E99675","#97BBCD","#B5BD89","#FF6F61","#6A5ACD"],u=U.value.map((s,o)=>{const i=[];return s.voltage_data.forEach(r=>{const v=`${r.date} ${r.time}`,g=new Date(v).getTime();i.push([g,r.avg_voltage])}),i.sort((r,v)=>r[0]-v[0]),{name:s.machine_name,data:i,color:c[o%c.length],type:"line",marker:{enabled:!1},connectNulls:!1}}),p=yt.chart(e,{chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},labels:{rotation:0,align:"center"},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const s=new Date(this.x),o=s.getFullYear(),i=String(s.getMonth()+1).padStart(2,"0"),r=String(s.getDate()).padStart(2,"0"),v=String(s.getHours()).padStart(2,"0"),g=String(s.getMinutes()).padStart(2,"0"),f=String(s.getSeconds()).padStart(2,"0");let G='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${o}-${i}-${r} ${v}:${g}:${f}`+"</div>";return this.points?.forEach(S=>{S.y!==null&&S.y!==void 0&&(G+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+S.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+S.color+'; font-weight: 700;">'+S.series.name+": "+S.y.toFixed(2)+" mV</span></div>")}),G}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"14px",fontWeight:"500",cursor:"pointer"},itemHoverStyle:{color:"#000"},symbolWidth:30,symbolHeight:16,symbolRadius:8,itemDistance:20,padding:15,itemMarginTop:8,itemMarginBottom:8},series:u,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"13px",fontWeight:"500"},symbolWidth:25,symbolHeight:14,itemDistance:15}}}]}});V.set(e,p)};return dt(()=>{z(),Y(),Z()}),ut(()=>{tt(),m&&(clearInterval(m),m=null)}),(e,t)=>{const c=E("el-card"),u=E("el-button"),p=E("el-dialog"),s=E("el-date-picker");return h(),w("div",St,[a("div",wt,[n(c,{class:"stat-card"},{header:l(()=>[...t[7]||(t[7]=[a("div",{class:"card-header"},"正在运行的设备",-1)])]),default:l(()=>[a("div",Dt,[a("div",xt,[(h(),w("svg",Ct,[t[8]||(t[8]=a("defs",null,[a("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[a("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),a("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[9]||(t[9]=a("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),a("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:gt({strokeDashoffset:502.4-502.4*N.value/15})},null,4)])),a("div",kt,[a("div",It,D(N.value),1),t[10]||(t[10]=a("div",{class:"circle-total"},"/15",-1))])]),a("div",$t,[a("div",{class:L(["status-indicator",B.value]),onClick:st,style:{cursor:"pointer"}},[t[11]||(t[11]=a("span",{class:"status-dot"},null,-1)),a("span",Mt,D(B.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),n(c,{class:"stat-card"},{header:l(()=>[...t[12]||(t[12]=[a("div",{class:"card-header"},"最近查询时间",-1)])]),default:l(()=>[a("div",Tt,[a("div",Ht,D(O.value),1),a("div",Vt,"自动刷新倒计时："+D(X.value),1)])]),_:1}),n(c,{class:"stat-card"},{header:l(()=>[...t[13]||(t[13]=[a("div",{class:"card-header"},"图表显示时间",-1)])]),default:l(()=>[a("div",Bt,[a("div",Rt,[a("button",{class:L(["day-btn",{active:H.value===1}]),onClick:t[0]||(t[0]=o=>P(1))}," 最近1天 ",2),a("button",{class:L(["day-btn",{active:H.value===7}]),onClick:t[1]||(t[1]=o=>P(7))}," 最近一周 ",2)])])]),_:1}),n(c,{class:"stat-card"},{header:l(()=>[...t[14]||(t[14]=[a("div",{class:"card-header"},"其他",-1)])]),default:l(()=>[a("div",Et,[n(u,{type:"success",class:"action-btn",onClick:lt},{default:l(()=>[...t[15]||(t[15]=[a("span",{class:"btn-icon"},"📥",-1),x(" 导出数据 ",-1)])]),_:1}),n(u,{type:"primary",class:"action-btn",onClick:et},{default:l(()=>[...t[16]||(t[16]=[a("span",{class:"btn-icon"},"📋",-1),x(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),q.value?(h(),w("div",Lt,[n(c,{class:"chart-card"},{header:l(()=>[...t[17]||(t[17]=[a("div",{class:"chart-title"},"总看板",-1)])]),default:l(()=>[n(_t)]),_:1})])):U.value.length===0?(h(),w("div",Ft,[n(c,{class:"no-data-card"},{default:l(()=>[...t[18]||(t[18]=[a("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(h(),vt(c,{key:2,class:"chart-card"},{header:l(()=>[...t[19]||(t[19]=[a("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:l(()=>[...t[20]||(t[20]=[a("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),n(p,{modelValue:I.value,"onUpdate:modelValue":t[3]||(t[3]=o=>I.value=o),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:l(()=>[a("div",At,[n(u,{onClick:t[2]||(t[2]=o=>$.value=[])},{default:l(()=>[...t[21]||(t[21]=[x("清除日志",-1)])]),_:1}),n(u,{type:"primary",onClick:ot},{default:l(()=>[...t[22]||(t[22]=[x("关闭",-1)])]),_:1})])]),default:l(()=>[a("div",qt,[a("div",{class:"logs-container",ref_key:"logsContainerRef",ref:R},[(h(!0),w(pt,null,ft($.value,(o,i)=>(h(),w("div",{key:i,class:L(["log-line",{"log-error":o.includes("[错误]"),"log-warning":o.includes("[警告]"),"log-success":o.includes("[成功]")}])},D(o),3))),128))],512)])]),_:1},8,["modelValue"]),n(p,{modelValue:M.value,"onUpdate:modelValue":t[6]||(t[6]=o=>M.value=o),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:l(()=>[a("div",zt,[n(u,{onClick:t[5]||(t[5]=o=>M.value=!1),disabled:T.value},{default:l(()=>[...t[24]||(t[24]=[x("取消",-1)])]),_:1},8,["disabled"]),n(u,{type:"primary",onClick:nt,loading:T.value},{default:l(()=>[x(D(T.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:l(()=>[a("div",Ut,[t[23]||(t[23]=a("div",{class:"date-range-label"},"选择时间范围",-1)),n(s,{modelValue:b.value,"onUpdate:modelValue":t[4]||(t[4]=o=>b.value=o),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),Xt=bt(Yt,[["__scopeId","data-v-747a00ce"]]);export{Xt as default};
