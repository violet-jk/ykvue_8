import{d as ht,r as p,b as A,w as yt,t as _t,U as Dt,c as h,o as f,a as e,R as r,I as St,J as n,al as U,az as bt,D as wt,P as y,E as k,O as D,Q as z,a6 as W,v as xt}from"./vue-kqFMiSVm.js";import{a as N}from"./utils-NIGUFBhG.js";import{H as Ct,C as kt}from"./ChartSkeleton-DgQIPAIF.js";import{E as T}from"./element-plus-CcUPQmts.js";import{_ as Tt}from"./index-sunFLjS_.js";import"./highcharts-DSb220Oi.js";const Mt={class:"home-container"},$t={class:"stats-row"},It={class:"stat-content"},Rt={class:"circle-progress"},Vt={viewBox:"0 0 200 200",class:"progress-svg"},Ft={class:"circle-text"},Ht={class:"circle-value"},Bt={class:"mqtt-status-badge"},Et={class:"status-text"},qt={class:"stat-content"},Lt={class:"stat-value"},At={class:"refresh-countdown"},Ut={class:"stat-content"},zt={class:"day-selector"},Wt={class:"button-group"},Nt={class:"devices-grid"},Ot={class:"device-name"},Yt={class:"device-voltage"},Qt={class:"voltage-value"},Pt={key:0,class:"charts-container"},jt={key:1,class:"charts-container"},Jt={class:"logs-dialog-content"},Gt={class:"dialog-footer"},Kt={class:"export-dialog-content"},Xt={class:"dialog-footer"},Zt={class:"changelog-dialog-content"},te={class:"changelog-header"},ee={class:"changelog-version"},se={class:"changelog-date"},ae={class:"changelog-content"},oe={class:"changelog-text"},ne={class:"dialog-footer"},le=ht({__name:"Home",setup(re){const at=bt(),O=p(!1),F=p((()=>{const s=localStorage.getItem("selectedDay");if(s){const t=parseInt(s);return[1,7].includes(t)?t:1}return 1})()),H=p(""),Y=p([]),B=new Map,M=p(300),E=p("stopped");let b=null,w=null;const Q=A(()=>Y.value.filter(s=>s.voltage_data.length>0)),G=A(()=>{const s=[];for(let t=1;t<=15;t++){const c=`${t}#`,i=Y.value.find(a=>a.machine_name===c);let u=0,l=!1;if(i&&i.voltage_data.length>0){const a=i.voltage_data[i.voltage_data.length-1],v=new Date(`${a.date} ${a.time}`).getTime(),d=new Date(H.value).getTime()-v,m=1800*1e3;d<=m?(u=Math.round(a.avg_voltage),l=u!==0):(u=0,l=!1)}s.push({machine_name:c,voltage:u,isRunning:l})}return s}),K=A(()=>G.value.filter(s=>s.isRunning).length),ot=A(()=>{const s=Math.floor(M.value/60),t=M.value%60;return`${s}:${t.toString().padStart(2,"0")}`}),P=async()=>{O.value=!0;try{const s=await N.get("/api/home/overview",{params:{day:F.value}});H.value=s.data.query_time,Y.value=s.data.devices,setTimeout(()=>{pt()},100)}catch(s){console.error("获取数据失败:",s),T.error("获取数据失败，请稍后重试")}finally{O.value=!1}},j=async()=>{try{const s=await N.get("/api/mqtt/status");E.value=s.data.connected?"running":"stopped"}catch(s){console.error("获取MQTT状态失败:",s),E.value="stopped"}},nt=()=>{b&&clearInterval(b),w&&clearInterval(w),b=setInterval(()=>{P(),j(),M.value=300},3e5),w=setInterval(()=>{M.value>0&&M.value--},1e3);const s=setInterval(()=>{j()},6e4);window.__mqttStatusInterval=s},lt=()=>{b&&(clearInterval(b),b=null),w&&(clearInterval(w),w=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},rt=()=>{at.push("/charts")},$=p(!1),q=p(null),I=p([]);let _=null;const it=async()=>{await xt(),q.value&&(q.value.scrollTop=q.value.scrollHeight)};let X="";yt(I,s=>{const t=s.length>0?s[s.length-1]:"";t&&t!==X&&(console.log("[日志] 检测到新日志，自动滚动到底部"),console.log(`[日志] 最新日志: ${t.substring(0,80)}...`),it()),X=t});const Z=async()=>{try{const s=await N.get("/api/mqtt/logs");I.value=s.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(s){console.error("获取MQTT日志失败:",s),I.value=["[系统] 获取日志失败"]}},ct=()=>{Z(),$.value=!0,_&&clearInterval(_),_=setInterval(()=>{$.value&&Z()},2e3)},dt=()=>{$.value=!1,_&&(clearInterval(_),_=null)},R=p(!1),V=p(!1),tt=()=>{const s=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,s]},x=p(tt()),L=p(!1),ut=[{version:"v1.0.0",date:"2025-10-27",changes:["新增主页看板, 显示当前所有设备的运行状态,每5分钟自动刷新数据","新增更新日志功能, 可查看系统历史更新记录","所有数据查看迁移至历史记录页面, 优化主页面布局","新增数据导出功能, 可选择时间范围(默认一个月)导出所有设备的数据为CSV文件","新增MQTT中转服务器状态显示, 实时查看服务器连接状态及日志"]}],gt=()=>{L.value=!0},vt=()=>{x.value=tt(),R.value=!0},mt=async()=>{if(!x.value||x.value.length!==2){T.warning("请选择起始和截止时间");return}const[s,t]=x.value,c=l=>{const a=l.getFullYear(),v=String(l.getMonth()+1).padStart(2,"0"),o=String(l.getDate()).padStart(2,"0"),d=String(l.getHours()).padStart(2,"0"),m=String(l.getMinutes()).padStart(2,"0"),g=String(l.getSeconds()).padStart(2,"0");return`${a}-${v}-${o} ${d}:${m}:${g}`},i=c(s),u=c(t);V.value=!0;try{const l=await N.get("/api/home/export",{params:{start_datetime:i,end_datetime:u},responseType:"blob"}),a=new Blob([l.data],{type:"text/csv;charset=utf-8;"}),v=window.URL.createObjectURL(a),o=document.createElement("a");o.href=v;const d=l.headers["content-disposition"];let m=`设备数据_${i.replace(/[:\s-]/g,"")}_${u.replace(/[:\s-]/g,"")}.csv`;if(d){const g=d.match(/filename=(.+)/);g&&g[1]&&(m=g[1])}o.download=m,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(v),T.success("数据导出成功"),R.value=!1}catch(l){if(console.error("导出数据失败:",l),l.response&&l.response.data){const a=new FileReader;a.onload=()=>{try{const v=JSON.parse(a.result);T.error(v.detail||"导出数据失败")}catch{T.error("导出数据失败，请稍后重试")}},a.readAsText(l.response.data)}else T.error("导出数据失败，请稍后重试")}finally{V.value=!1}},et=s=>{F.value=s,localStorage.setItem("selectedDay",s.toString()),P()},pt=()=>{if(Q.value.length===0)return;const s="combined-chart";if(!document.getElementById(s))return;if(B.has(s)){const o=B.get(s);o&&o.destroy(),B.delete(s)}const c=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7F","#BCBD22","#17BECF","#FFA600","#FF0054","#00CC96","#AB63FA","#19D3F3"],i=Q.value.map((o,d)=>{const m=[];return o.voltage_data.forEach(g=>{const S=`${g.date} ${g.time}`,J=new Date(S).getTime();m.push([J,g.avg_voltage])}),m.sort((g,S)=>g[0]-S[0]),{name:o.machine_name,data:m,color:c[d%c.length],type:"line",marker:{enabled:!1},connectNulls:!1}});let u=0;i.forEach(o=>{if(o.data.length>0){const d=o.data[o.data.length-1];d[0]>u&&(u=d[0])}});const l=new Date(H.value).getTime(),a=u<l?l:void 0,v=Ct.chart(s,{time:{useUTC:!1},chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},max:a,labels:{rotation:0,align:"center",useHTML:!0,formatter:function(){const o=new Date(this.value),d=String(o.getMonth()+1).padStart(2,"0"),m=String(o.getDate()).padStart(2,"0"),g=String(o.getHours()).padStart(2,"0"),S=String(o.getMinutes()).padStart(2,"0");return'<div style="text-align: center;"><div style="color: #666; font-size: 11px; font-weight: 600;">'+d+"-"+m+'</div><div style="color: #333; font-size: 12px; font-weight: 700; margin-top: 2px;">'+g+":"+S+"</div></div>"}}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const o=new Date(this.x),d=o.getFullYear(),m=String(o.getMonth()+1).padStart(2,"0"),g=String(o.getDate()).padStart(2,"0"),S=String(o.getHours()).padStart(2,"0"),J=String(o.getMinutes()).padStart(2,"0"),ft=String(o.getSeconds()).padStart(2,"0");let st='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${d}-${m}-${g} ${S}:${J}:${ft}`+"</div>";return this.points?.forEach(C=>{C.y!==null&&C.y!==void 0&&(st+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+C.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+C.color+'; font-weight: 700;">'+C.series.name+": "+C.y.toFixed(0)+" mV</span></div>")}),st}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"14px",fontWeight:"500",cursor:"pointer"},itemHoverStyle:{color:"#000"},symbolWidth:30,symbolHeight:16,symbolRadius:8,itemDistance:20,padding:15,itemMarginTop:8,itemMarginBottom:8},series:i,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"13px",fontWeight:"500"},symbolWidth:25,symbolHeight:14,itemDistance:15}}}]}});B.set(s,v)};return _t(()=>{P(),j(),nt()}),Dt(()=>{lt(),_&&(clearInterval(_),_=null)}),(s,t)=>{const c=U("el-card"),i=U("el-button"),u=U("el-dialog"),l=U("el-date-picker");return f(),h("div",Mt,[e("div",$t,[r(c,{class:"stat-card"},{header:n(()=>[...t[9]||(t[9]=[e("div",{class:"card-header"},"正在运行的设备",-1)])]),default:n(()=>[e("div",It,[e("div",Rt,[(f(),h("svg",Vt,[t[10]||(t[10]=e("defs",null,[e("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[e("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),e("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[11]||(t[11]=e("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),e("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:wt({strokeDashoffset:502.4-502.4*K.value/15})},null,4)])),e("div",Ft,[e("div",Ht,y(K.value),1),t[12]||(t[12]=e("div",{class:"circle-total"},"/15",-1))])]),e("div",Bt,[e("div",{class:k(["status-indicator",E.value]),onClick:ct,style:{cursor:"pointer"}},[t[13]||(t[13]=e("span",{class:"status-dot"},null,-1)),e("span",Et,y(E.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),r(c,{class:"stat-card"},{header:n(()=>[...t[14]||(t[14]=[e("div",{class:"card-header"},"最近查询时间",-1)])]),default:n(()=>[e("div",qt,[e("div",Lt,y(H.value),1),e("div",At,"自动刷新倒计时："+y(ot.value),1)])]),_:1}),r(c,{class:"stat-card"},{header:n(()=>[...t[15]||(t[15]=[e("div",{class:"card-header"},"图表显示时间",-1)])]),default:n(()=>[e("div",Ut,[e("div",zt,[e("button",{class:k(["day-btn",{active:F.value===1}]),onClick:t[0]||(t[0]=a=>et(1))}," 最近1天 ",2),e("button",{class:k(["day-btn",{active:F.value===7}]),onClick:t[1]||(t[1]=a=>et(7))}," 最近一周 ",2)])])]),_:1}),r(c,{class:"stat-card"},{header:n(()=>[...t[16]||(t[16]=[e("div",{class:"card-header"},"其他",-1)])]),default:n(()=>[e("div",Wt,[r(i,{type:"info",class:"action-btn",onClick:gt},{default:n(()=>[...t[17]||(t[17]=[e("span",{class:"btn-icon"},"📝",-1),D(" 更新日志 ",-1)])]),_:1}),r(i,{type:"success",class:"action-btn",onClick:vt},{default:n(()=>[...t[18]||(t[18]=[e("span",{class:"btn-icon"},"📥",-1),D(" 导出数据 ",-1)])]),_:1}),r(i,{type:"primary",class:"action-btn",onClick:rt},{default:n(()=>[...t[19]||(t[19]=[e("span",{class:"btn-icon"},"📋",-1),D(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),r(c,{class:"voltage-status-card"},{header:n(()=>[...t[20]||(t[20]=[e("div",{class:"voltage-status-header"},[e("span",{class:"voltage-status-title"},"设备实时电压状态"),e("span",{class:"voltage-status-subtitle"},"（绿色：运行中 | 灰色：停止）")],-1)])]),default:n(()=>[e("div",Nt,[(f(!0),h(z,null,W(G.value,a=>(f(),h("div",{key:a.machine_name,class:k(["device-item",{running:a.isRunning,stopped:!a.isRunning}])},[e("div",{class:k(["device-status-dot",{running:a.isRunning,stopped:!a.isRunning}])},null,2),e("div",Ot,y(a.machine_name),1),e("div",Yt,[e("span",Qt,y(a.voltage),1),t[21]||(t[21]=e("span",{class:"voltage-unit"},"mV",-1))])],2))),128))])]),_:1}),O.value?(f(),h("div",Pt,[r(c,{class:"chart-card"},{header:n(()=>[...t[22]||(t[22]=[e("div",{class:"chart-title"},"总看板",-1)])]),default:n(()=>[r(kt)]),_:1})])):Q.value.length===0?(f(),h("div",jt,[r(c,{class:"no-data-card"},{default:n(()=>[...t[23]||(t[23]=[e("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(f(),St(c,{key:2,class:"chart-card"},{header:n(()=>[...t[24]||(t[24]=[e("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:n(()=>[...t[25]||(t[25]=[e("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),r(u,{modelValue:$.value,"onUpdate:modelValue":t[3]||(t[3]=a=>$.value=a),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:n(()=>[e("div",Gt,[r(i,{onClick:t[2]||(t[2]=a=>I.value=[])},{default:n(()=>[...t[26]||(t[26]=[D("清除日志",-1)])]),_:1}),r(i,{type:"primary",onClick:dt},{default:n(()=>[...t[27]||(t[27]=[D("关闭",-1)])]),_:1})])]),default:n(()=>[e("div",Jt,[e("div",{class:"logs-container",ref_key:"logsContainerRef",ref:q},[(f(!0),h(z,null,W(I.value,(a,v)=>(f(),h("div",{key:v,class:k(["log-line",{"log-error":a.includes("[错误]"),"log-warning":a.includes("[警告]"),"log-success":a.includes("[成功]")}])},y(a),3))),128))],512)])]),_:1},8,["modelValue"]),r(u,{modelValue:R.value,"onUpdate:modelValue":t[6]||(t[6]=a=>R.value=a),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:n(()=>[e("div",Xt,[r(i,{onClick:t[5]||(t[5]=a=>R.value=!1),disabled:V.value},{default:n(()=>[...t[29]||(t[29]=[D("取消",-1)])]),_:1},8,["disabled"]),r(i,{type:"primary",onClick:mt,loading:V.value},{default:n(()=>[D(y(V.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:n(()=>[e("div",Kt,[t[28]||(t[28]=e("div",{class:"date-range-label"},"选择时间范围",-1)),r(l,{modelValue:x.value,"onUpdate:modelValue":t[4]||(t[4]=a=>x.value=a),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"]),r(u,{modelValue:L.value,"onUpdate:modelValue":t[8]||(t[8]=a=>L.value=a),title:"更新日志",width:"700px","close-on-click-modal":!1},{footer:n(()=>[e("div",ne,[r(i,{type:"primary",onClick:t[7]||(t[7]=a=>L.value=!1)},{default:n(()=>[...t[31]||(t[31]=[D("关闭",-1)])]),_:1})])]),default:n(()=>[e("div",Zt,[(f(),h(z,null,W(ut,(a,v)=>e("div",{key:v,class:"changelog-item"},[e("div",te,[e("div",ee,y(a.version),1),e("div",se,y(a.date),1)]),e("div",ae,[(f(!0),h(z,null,W(a.changes,(o,d)=>(f(),h("div",{key:d,class:"changelog-change"},[t[30]||(t[30]=e("span",{class:"changelog-icon"},"•",-1)),e("span",oe,y(o),1)]))),128))])])),64))])]),_:1},8,["modelValue"])])}}}),fe=Tt(le,[["__scopeId","data-v-3d833e2e"]]);export{fe as default};
