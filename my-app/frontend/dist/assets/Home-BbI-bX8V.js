import{d as at,r as m,b as U,t as st,U as ot,c as F,o as k,a as e,I as nt,R as i,J as n,al as H,az as rt,D as lt,P as M,E as Y,O as V}from"./vue-kqFMiSVm.js";import{a as z}from"./utils-NIGUFBhG.js";import{H as it,C as dt}from"./ChartSkeleton-D3hQGoqu.js";import{E as S}from"./element-plus-CcUPQmts.js";import{_ as ct}from"./index-DQzAWvJv.js";import"./highcharts-DSb220Oi.js";const ut={class:"home-container"},vt={class:"stats-row"},mt={class:"stat-content"},pt={class:"circle-progress"},gt={viewBox:"0 0 200 200",class:"progress-svg"},ft={class:"circle-text"},ht={class:"circle-value"},yt={class:"mqtt-status-badge"},_t={class:"status-text"},wt={class:"stat-content"},bt={class:"stat-value"},St={class:"refresh-countdown"},Dt={class:"stat-content"},xt={class:"day-selector"},Ct={class:"button-group"},kt={key:0,class:"charts-container"},Mt={key:1,class:"charts-container"},$t={class:"export-dialog-content"},Et={class:"dialog-footer"},It=at({__name:"Home",setup(Bt){const J=rt(),A=m(!1),$=m(1),O=m(""),R=m([]),E=new Map,D=m(300),I=m("stopped");let h=null,y=null;const N=U(()=>R.value.filter(a=>a.voltage_data.length===0?!1:a.voltage_data[a.voltage_data.length-1].avg_voltage>=100).length),B=U(()=>R.value.filter(a=>a.voltage_data.length>0)),G=U(()=>{const a=Math.floor(D.value/60),t=D.value%60;return`${a}:${t.toString().padStart(2,"0")}`}),q=async()=>{A.value=!0;try{const a=await z.get("/api/home/overview",{params:{day:$.value}});O.value=a.data.query_time,R.value=a.data.devices,setTimeout(()=>{et()},100)}catch(a){console.error("获取数据失败:",a),S.error("获取数据失败，请稍后重试")}finally{A.value=!1}},L=async()=>{try{const a=await z.get("/api/mqtt/status");I.value=a.data.connected?"running":"stopped"}catch(a){console.error("获取MQTT状态失败:",a),I.value="stopped"}},Q=()=>{h&&clearInterval(h),y&&clearInterval(y),h=setInterval(()=>{q(),L(),D.value=300},3e5),y=setInterval(()=>{D.value>0&&D.value--},1e3);const a=setInterval(()=>{L()},6e4);window.__mqttStatusInterval=a},K=()=>{h&&(clearInterval(h),h=null),y&&(clearInterval(y),y=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},X=()=>{J.push("/charts")},x=m(!1),C=m(!1),P=()=>{const a=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,a]},_=m(P()),Z=()=>{_.value=P(),x.value=!0},tt=async()=>{if(!_.value||_.value.length!==2){S.warning("请选择起始和截止时间");return}const[a,t]=_.value,l=o=>{const r=o.getFullYear(),p=String(o.getMonth()+1).padStart(2,"0"),s=String(o.getDate()).padStart(2,"0"),d=String(o.getHours()).padStart(2,"0"),u=String(o.getMinutes()).padStart(2,"0"),v=String(o.getSeconds()).padStart(2,"0");return`${r}-${p}-${s} ${d}:${u}:${v}`},c=l(a),g=l(t);C.value=!0;try{const o=await z.get("/api/home/export",{params:{start_datetime:c,end_datetime:g},responseType:"blob"}),r=new Blob([o.data],{type:"text/csv;charset=utf-8;"}),p=window.URL.createObjectURL(r),s=document.createElement("a");s.href=p;const d=o.headers["content-disposition"];let u=`设备数据_${c.replace(/[:\s-]/g,"")}_${g.replace(/[:\s-]/g,"")}.csv`;if(d){const v=d.match(/filename=(.+)/);v&&v[1]&&(u=v[1])}s.download=u,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(p),S.success("数据导出成功"),x.value=!1}catch(o){if(console.error("导出数据失败:",o),o.response&&o.response.data){const r=new FileReader;r.onload=()=>{try{const p=JSON.parse(r.result);S.error(p.detail||"导出数据失败")}catch{S.error("导出数据失败，请稍后重试")}},r.readAsText(o.response.data)}else S.error("导出数据失败，请稍后重试")}finally{C.value=!1}},W=a=>{$.value=a,q()},et=()=>{if(B.value.length===0)return;const a="combined-chart";if(!document.getElementById(a))return;if(E.has(a)){const s=E.get(a);s&&s.destroy(),E.delete(a)}const l=new Set;B.value.forEach(s=>{s.voltage_data.forEach(d=>{l.add(`${d.date} ${d.time}`)})});const c=Array.from(l).sort(),g=c.map(s=>new Date(s).getTime()),o=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#EFC94C","#17BECF","#4C72B0","#DD8452","#55A868","#C44E52","#8172B3","#937860","#64B5CD","#E99675","#97BBCD","#B5BD89","#FF6F61","#6A5ACD"],r=B.value.map((s,d)=>{const u=new Map;s.voltage_data.forEach(f=>{const w=`${f.date} ${f.time}`;u.set(w,f.avg_voltage)});const v=c.map((f,w)=>{const T=u.get(f);return T!==void 0?[g[w],T]:[g[w],null]});return{name:s.machine_name,data:v,color:o[d%o.length],type:"line",marker:{enabled:!1}}}),p=it.chart(a,{chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},labels:{rotation:0,align:"center"},dateTimeLabelFormats:{millisecond:"%H:%M:%S.%L",second:"%H:%M:%S",minute:"%H:%M",hour:"%H:%M",day:"%m-%d",week:"%m-%d",month:"%Y-%m",year:"%Y"}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const s=new Date(this.x),d=s.getFullYear(),u=String(s.getMonth()+1).padStart(2,"0"),v=String(s.getDate()).padStart(2,"0"),f=String(s.getHours()).padStart(2,"0"),w=String(s.getMinutes()).padStart(2,"0"),T=String(s.getSeconds()).padStart(2,"0");let j='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${d}-${u}-${v} ${f}:${w}:${T}`+"</div>";return this.points?.forEach(b=>{b.y!==null&&b.y!==void 0&&(j+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+b.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+b.color+'; font-weight: 700;">'+b.series.name+": "+b.y.toFixed(2)+" mV</span></div>")}),j}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom"},series:r,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom"}}}]}});E.set(a,p)};return st(()=>{q(),L(),Q()}),ot(()=>{K()}),(a,t)=>{const l=H("el-card"),c=H("el-button"),g=H("el-date-picker"),o=H("el-dialog");return k(),F("div",ut,[e("div",vt,[i(l,{class:"stat-card"},{header:n(()=>[...t[5]||(t[5]=[e("div",{class:"card-header"},"正在运行的设备",-1)])]),default:n(()=>[e("div",mt,[e("div",pt,[(k(),F("svg",gt,[t[6]||(t[6]=e("defs",null,[e("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[e("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),e("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[7]||(t[7]=e("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),e("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:lt({strokeDashoffset:502.4-502.4*N.value/15})},null,4)])),e("div",ft,[e("div",ht,M(N.value),1),t[8]||(t[8]=e("div",{class:"circle-total"},"/15",-1))])]),e("div",yt,[e("div",{class:Y(["status-indicator",I.value])},[t[9]||(t[9]=e("span",{class:"status-dot"},null,-1)),e("span",_t,M(I.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),i(l,{class:"stat-card"},{header:n(()=>[...t[10]||(t[10]=[e("div",{class:"card-header"},"最近查询时间",-1)])]),default:n(()=>[e("div",wt,[e("div",bt,M(O.value),1),e("div",St,"自动刷新倒计时："+M(G.value),1)])]),_:1}),i(l,{class:"stat-card"},{header:n(()=>[...t[11]||(t[11]=[e("div",{class:"card-header"},"图表显示时间",-1)])]),default:n(()=>[e("div",Dt,[e("div",xt,[e("button",{class:Y(["day-btn",{active:$.value===1}]),onClick:t[0]||(t[0]=r=>W(1))}," 最近1天 ",2),e("button",{class:Y(["day-btn",{active:$.value===7}]),onClick:t[1]||(t[1]=r=>W(7))}," 最近一周 ",2)])])]),_:1}),i(l,{class:"stat-card"},{header:n(()=>[...t[12]||(t[12]=[e("div",{class:"card-header"},"其他",-1)])]),default:n(()=>[e("div",Ct,[i(c,{type:"success",class:"action-btn",onClick:Z},{default:n(()=>[...t[13]||(t[13]=[e("span",{class:"btn-icon"},"📥",-1),V(" 导出数据 ",-1)])]),_:1}),i(c,{type:"primary",class:"action-btn",onClick:X},{default:n(()=>[...t[14]||(t[14]=[e("span",{class:"btn-icon"},"📋",-1),V(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),A.value?(k(),F("div",kt,[i(l,{class:"chart-card"},{header:n(()=>[...t[15]||(t[15]=[e("div",{class:"chart-title"},"总看板",-1)])]),default:n(()=>[i(dt)]),_:1})])):B.value.length===0?(k(),F("div",Mt,[i(l,{class:"no-data-card"},{default:n(()=>[...t[16]||(t[16]=[e("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(k(),nt(l,{key:2,class:"chart-card"},{header:n(()=>[...t[17]||(t[17]=[e("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:n(()=>[...t[18]||(t[18]=[e("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),i(o,{modelValue:x.value,"onUpdate:modelValue":t[4]||(t[4]=r=>x.value=r),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:n(()=>[e("div",Et,[i(c,{onClick:t[3]||(t[3]=r=>x.value=!1),disabled:C.value},{default:n(()=>[...t[20]||(t[20]=[V("取消",-1)])]),_:1},8,["disabled"]),i(c,{type:"primary",onClick:tt,loading:C.value},{default:n(()=>[V(M(C.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:n(()=>[e("div",$t,[t[19]||(t[19]=e("div",{class:"date-range-label"},"选择时间范围",-1)),i(g,{modelValue:_.value,"onUpdate:modelValue":t[2]||(t[2]=r=>_.value=r),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),Lt=ct(It,[["__scopeId","data-v-30c969a3"]]);export{Lt as default};
