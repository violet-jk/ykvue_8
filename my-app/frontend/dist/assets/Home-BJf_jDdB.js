import{d as kt,r as p,b as Q,w as $t,t as Tt,U as Mt,c as y,o as h,a as e,R as c,I as Ft,J as l,al as N,az as It,D as zt,P as x,E as M,O as b,Q as j,a6 as J,v as dt}from"./vue-kqFMiSVm.js";import{a as G}from"./utils-NIGUFBhG.js";import{H as ct,C as Bt}from"./ChartSkeleton-DEPsD-ld.js";import{E as C}from"./element-plus-CcUPQmts.js";import{_ as Vt}from"./index-YAwsYAcE.js";import"./highcharts-DSb220Oi.js";const At={class:"home-container"},Rt={class:"stats-row"},Et={class:"stat-content"},Lt={class:"circle-progress"},Ht={viewBox:"0 0 200 200",class:"progress-svg"},Wt={class:"circle-text"},qt={class:"circle-value"},Ut={class:"mqtt-status-badge"},Ot={class:"status-text"},Yt={class:"stat-content"},Pt={class:"stat-value"},Qt={class:"refresh-countdown"},Nt={class:"stat-content"},jt={class:"day-selector"},Jt={class:"button-group"},Gt={class:"devices-grid"},Kt=["onClick"],Xt={class:"device-name"},Zt={class:"device-voltage"},te={class:"voltage-value"},ee={key:0,class:"charts-container"},ae={key:1,class:"charts-container"},se={class:"logs-dialog-content"},oe={class:"dialog-footer"},ne={class:"export-dialog-content"},le={class:"dialog-footer"},ie={class:"changelog-dialog-content"},re={class:"changelog-header"},de={class:"changelog-version"},ce={class:"changelog-date"},ue={class:"changelog-content"},ge={class:"changelog-text"},ve={class:"dialog-footer"},me={class:"dialog-footer"},pe=kt({__name:"Home",setup(fe){const ut=It(),K=p(!1),F=p((()=>{const a=localStorage.getItem("selectedDay");if(a){const t=parseInt(a);return[1,7].includes(t)?t:1}return 1})()),I=p(""),L=p([]),H=new Map,z=p(300),W=p("stopped");let k=null,$=null;const q=Q(()=>L.value.filter(a=>a.voltage_data.length>0)),tt=Q(()=>{const a=[];for(let t=1;t<=15;t++){const v=`${t}#`,i=L.value.find(s=>s.machine_name===v);let u=0,r=!1;if(i&&i.voltage_data.length>0){const s=i.voltage_data[i.voltage_data.length-1],m=new Date(`${s.date} ${s.time}`).getTime(),g=new Date(I.value).getTime()-m,o=1800*1e3;g<=o?(u=Math.round(s.avg_voltage),r=u>0):(u=0,r=!1)}a.push({machine_name:v,voltage:u,isRunning:r})}return a}),et=Q(()=>tt.value.filter(a=>a.isRunning).length),gt=Q(()=>{const a=Math.floor(z.value/60),t=z.value%60;return`${a}:${t.toString().padStart(2,"0")}`}),X=async()=>{K.value=!0;try{const a=await G.get("/api/home/overview",{params:{day:F.value}});I.value=a.data.query_time,L.value=a.data.devices,setTimeout(()=>{Ct()},100)}catch(a){console.error("获取数据失败:",a),C.error("获取数据失败，请稍后重试")}finally{K.value=!1}},Z=async()=>{try{const a=await G.get("/api/mqtt/status");W.value=a.data.connected?"running":"stopped"}catch(a){console.error("获取MQTT状态失败:",a),W.value="stopped"}},vt=()=>{k&&clearInterval(k),$&&clearInterval($),k=setInterval(()=>{X(),Z(),z.value=300},3e5),$=setInterval(()=>{z.value>0&&z.value--},1e3);const a=setInterval(()=>{Z()},6e4);window.__mqttStatusInterval=a},mt=()=>{k&&(clearInterval(k),k=null),$&&(clearInterval($),$=null),window.__mqttStatusInterval&&(clearInterval(window.__mqttStatusInterval),window.__mqttStatusInterval=null)},pt=()=>{ut.push("/charts")},B=p(!1),U=p(null),V=p([]);let S=null;const ft=async()=>{await dt(),U.value&&(U.value.scrollTop=U.value.scrollHeight)};let at="";$t(V,a=>{const t=a.length>0?a[a.length-1]:"";t&&t!==at&&(console.log("[日志] 检测到新日志，自动滚动到底部"),console.log(`[日志] 最新日志: ${t.substring(0,80)}...`),ft()),at=t});const st=async()=>{try{const a=await G.get("/api/mqtt/logs");V.value=a.data.logs.map(t=>`[${t.timestamp}] [${t.level}] ${t.message}`)}catch(a){console.error("获取MQTT日志失败:",a),V.value=["[系统] 获取日志失败"]}},ht=()=>{st(),B.value=!0,S&&clearInterval(S),S=setInterval(()=>{B.value&&st()},1e4)},yt=()=>{B.value=!1,S&&(clearInterval(S),S=null)},A=p(!1),R=p(!1),ot=()=>{const a=new Date,t=new Date;return t.setMonth(t.getMonth()-1),[t,a]},T=p(ot()),O=p(!1),Y=p(!1),nt=p("");let _=null;const xt=[{version:"v1.0.0",date:"2025-10-27",changes:["新增主页看板, 显示当前所有设备的运行状态,每5分钟自动刷新数据","新增更新日志功能, 可查看系统历史更新记录","所有数据查看迁移至历史记录页面, 优化主页面布局","新增数据导出功能, 可选择时间范围(默认一个月)导出所有设备的数据为CSV文件","新增MQTT中转服务器状态显示, 实时查看服务器连接状态及日志"]}],St=()=>{O.value=!0},bt=()=>{T.value=ot(),A.value=!0},_t=async()=>{if(!T.value||T.value.length!==2){C.warning("请选择起始和截止时间");return}const[a,t]=T.value,v=r=>{const s=r.getFullYear(),m=String(r.getMonth()+1).padStart(2,"0"),n=String(r.getDate()).padStart(2,"0"),g=String(r.getHours()).padStart(2,"0"),o=String(r.getMinutes()).padStart(2,"0"),d=String(r.getSeconds()).padStart(2,"0");return`${s}-${m}-${n} ${g}:${o}:${d}`},i=v(a),u=v(t);R.value=!0;try{const r=await G.get("/api/home/export",{params:{start_datetime:i,end_datetime:u},responseType:"blob"}),s=new Blob([r.data],{type:"text/csv;charset=utf-8;"}),m=window.URL.createObjectURL(s),n=document.createElement("a");n.href=m;const g=r.headers["content-disposition"];let o=`设备数据_${i.replace(/[:\s-]/g,"")}_${u.replace(/[:\s-]/g,"")}.csv`;if(g){const d=g.match(/filename=(.+)/);d&&d[1]&&(o=d[1])}n.download=o,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(m),C.success("数据导出成功"),A.value=!1}catch(r){if(console.error("导出数据失败:",r),r.response&&r.response.data){const s=new FileReader;s.onload=()=>{try{const m=JSON.parse(s.result);C.error(m.detail||"导出数据失败")}catch{C.error("导出数据失败，请稍后重试")}},s.readAsText(r.response.data)}else C.error("导出数据失败，请稍后重试")}finally{R.value=!1}},lt=a=>{F.value=a,localStorage.setItem("selectedDay",a.toString()),X()},Dt=a=>{nt.value=a,Y.value=!0,dt(()=>{wt(a)})},wt=a=>{const t=L.value.find(o=>o.machine_name===a);if(!t||t.voltage_data.length===0){C.warning("该设备暂无数据");return}if(!document.getElementById("device-detail-chart"))return;_&&(_.destroy(),_=null);const i=[];t.voltage_data.forEach(o=>{const d=`${o.date} ${o.time}`,f=new Date(d).getTime();i.push([f,o.avg_voltage])}),i.sort((o,d)=>o[0]-d[0]);const u=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7F","#BCBD22","#17BECF","#FFA600","#FF0054","#00CC96","#AB63FA","#19D3F3"],r=q.value.findIndex(o=>o.machine_name===a),s=u[r%u.length];let m=0;i.length>0&&(m=i[i.length-1][0]);const n=new Date(I.value).getTime(),g=m<n?n:void 0;_=ct.chart("device-detail-chart",{time:{useUTC:!1},chart:{type:"line",height:600,marginBottom:100,marginTop:80,spacingBottom:15,spacingRight:15,spacingLeft:15,spacingTop:10},title:{text:`${a} 电压趋势`,style:{fontSize:"22px",fontWeight:"bold",color:"#1e293b"}},subtitle:{text:`数据点数: ${i.length} | 时间范围: ${F.value===1?"最近1天":"最近7天"}`,style:{fontSize:"14px",color:"#64748b"}},xAxis:{type:"datetime",title:{text:"时间",style:{fontSize:"16px",fontWeight:"600",color:"#334155"},margin:20},max:g,labels:{rotation:0,align:"center",useHTML:!0,style:{fontSize:"13px"},y:35,formatter:function(){const o=new Date(this.value),d=String(o.getMonth()+1).padStart(2,"0"),f=String(o.getDate()).padStart(2,"0"),D=String(o.getHours()).padStart(2,"0"),E=String(o.getMinutes()).padStart(2,"0");return'<div style="text-align: center;"><div style="color: #666; font-size: 13px; font-weight: 600;">'+d+"-"+f+'</div><div style="color: #333; font-size: 14px; font-weight: 700; margin-top: 2px;">'+D+":"+E+"</div></div>"}},gridLineWidth:1,gridLineColor:"#f1f5f9"},yAxis:{title:{text:"平均电压值 (mV)",style:{fontSize:"16px",fontWeight:"600",color:"#334155"}},min:0,labels:{style:{fontSize:"13px",color:"#64748b"}},gridLineWidth:1,gridLineColor:"#f1f5f9"},tooltip:{backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const o=new Date(this.x),d=o.getFullYear(),f=String(o.getMonth()+1).padStart(2,"0"),D=String(o.getDate()).padStart(2,"0"),E=String(o.getHours()).padStart(2,"0"),it=String(o.getMinutes()).padStart(2,"0"),P=String(o.getSeconds()).padStart(2,"0");let rt='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 14px;">'+`${d}-${f}-${D} ${E}:${it}:${P}`+"</div>";return rt+='<div style="margin: 4px 0; color: #333; font-weight: 500; font-size: 14px;"><span style="color: '+s+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+s+'; font-weight: 700;">电压: '+this.y.toFixed(0)+" mV</span></div>",rt}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"top",y:10,itemStyle:{fontSize:"14px",fontWeight:"600",color:"#334155"}},series:[{name:`${a} - 电压`,data:i,color:s,type:"line",lineWidth:3,marker:{enabled:!1,radius:3,symbol:"circle"},states:{hover:{lineWidthPlus:2}},dataLabels:{enabled:!1}}],credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:1400},chartOptions:{chart:{height:550,marginBottom:90},title:{style:{fontSize:"20px"}},xAxis:{labels:{y:30,style:{fontSize:"12px"}}}}},{condition:{maxWidth:800},chartOptions:{chart:{height:450,marginBottom:80},title:{style:{fontSize:"18px"}},subtitle:{style:{fontSize:"12px"}},xAxis:{labels:{rotation:-30,align:"right",y:20,style:{fontSize:"11px"}}}}},{condition:{maxWidth:500},chartOptions:{chart:{height:350,marginBottom:70},title:{style:{fontSize:"16px"}},xAxis:{labels:{rotation:-45,align:"right",y:15,style:{fontSize:"10px"}}}}}]}}),console.log("图表创建完成")},Ct=()=>{if(q.value.length===0)return;const a="combined-chart";if(!document.getElementById(a))return;if(H.has(a)){const n=H.get(a);n&&n.destroy(),H.delete(a)}const v=["#1F77B4","#FF7F0E","#2CA02C","#D62728","#9467BD","#8C564B","#E377C2","#7F7F7F","#BCBD22","#17BECF","#FFA600","#FF0054","#00CC96","#AB63FA","#19D3F3"],i=q.value.map((n,g)=>{const o=[];return n.voltage_data.forEach(d=>{const f=`${d.date} ${d.time}`,D=new Date(f).getTime();o.push([D,d.avg_voltage])}),o.sort((d,f)=>d[0]-f[0]),{name:n.machine_name,data:o,color:v[g%v.length],type:"line",marker:{enabled:!1},connectNulls:!1}});let u=0;i.forEach(n=>{if(n.data.length>0){const g=n.data[n.data.length-1];g[0]>u&&(u=g[0])}});const r=new Date(I.value).getTime(),s=u<r?r:void 0,m=ct.chart(a,{time:{useUTC:!1},chart:{type:"line",height:550},title:{text:""},xAxis:{type:"datetime",title:{text:"时间"},max:s,labels:{rotation:0,align:"center",useHTML:!0,formatter:function(){const n=new Date(this.value),g=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0"),d=String(n.getHours()).padStart(2,"0"),f=String(n.getMinutes()).padStart(2,"0");return'<div style="text-align: center;"><div style="color: #666; font-size: 11px; font-weight: 600;">'+g+"-"+o+'</div><div style="color: #333; font-size: 12px; font-weight: 700; margin-top: 2px;">'+d+":"+f+"</div></div>"}}},yAxis:{title:{text:"平均电压值 (mV)"},min:0},tooltip:{shared:!0,crosshairs:!0,backgroundColor:"rgba(255, 255, 255, 0.95)",borderColor:"#ddd",borderRadius:8,borderWidth:1,padding:12,useHTML:!0,formatter:function(){const n=new Date(this.x),g=n.getFullYear(),o=String(n.getMonth()+1).padStart(2,"0"),d=String(n.getDate()).padStart(2,"0"),f=String(n.getHours()).padStart(2,"0"),D=String(n.getMinutes()).padStart(2,"0"),E=String(n.getSeconds()).padStart(2,"0");let P='<div style="color: #333; font-weight: 700; margin-bottom: 8px; font-size: 13px;">'+`${g}-${o}-${d} ${f}:${D}:${E}`+"</div>";return this.points?.forEach(w=>{w.y!==null&&w.y!==void 0&&(P+='<div style="margin: 4px 0; color: #333; font-weight: 500;"><span style="color: '+w.color+'; font-weight: 700; margin-right: 6px;">●</span><span style="color: '+w.color+'; font-weight: 700;">'+w.series.name+": "+w.y.toFixed(0)+" mV</span></div>")}),P}},legend:{enabled:!0,layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"14px",fontWeight:"500",cursor:"pointer"},itemHoverStyle:{color:"#000"},symbolWidth:30,symbolHeight:16,symbolRadius:8,itemDistance:20,padding:15,itemMarginTop:8,itemMarginBottom:8},series:i,credits:{enabled:!1},responsive:{rules:[{condition:{maxWidth:500},chartOptions:{xAxis:{labels:{rotation:-45,align:"right"}},legend:{layout:"horizontal",align:"center",verticalAlign:"bottom",itemStyle:{fontSize:"13px",fontWeight:"500"},symbolWidth:25,symbolHeight:14,itemDistance:15}}}]}});H.set(a,m)};return Tt(()=>{X(),Z(),vt()}),Mt(()=>{mt(),S&&(clearInterval(S),S=null),_&&(_.destroy(),_=null)}),(a,t)=>{const v=N("el-card"),i=N("el-button"),u=N("el-dialog"),r=N("el-date-picker");return h(),y("div",At,[e("div",Rt,[c(v,{class:"stat-card"},{header:l(()=>[...t[11]||(t[11]=[e("div",{class:"card-header"},"正在运行的设备",-1)])]),default:l(()=>[e("div",Et,[e("div",Lt,[(h(),y("svg",Ht,[t[12]||(t[12]=e("defs",null,[e("linearGradient",{id:"gradientStroke",x1:"0%",y1:"0%",x2:"100%",y2:"100%"},[e("stop",{offset:"0%",style:{"stop-color":"#4facfe","stop-opacity":"1"}}),e("stop",{offset:"100%",style:{"stop-color":"#00f2fe","stop-opacity":"1"}})])],-1)),t[13]||(t[13]=e("circle",{cx:"100",cy:"100",r:"80",class:"progress-bg"},null,-1)),e("circle",{cx:"100",cy:"100",r:"80",class:"progress-circle",style:zt({strokeDashoffset:502.4-502.4*et.value/15})},null,4)])),e("div",Wt,[e("div",qt,x(et.value),1),t[14]||(t[14]=e("div",{class:"circle-total"},"/15",-1))])]),e("div",Ut,[e("div",{class:M(["status-indicator",W.value]),onClick:ht,style:{cursor:"pointer"}},[t[15]||(t[15]=e("span",{class:"status-dot"},null,-1)),e("span",Ot,x(W.value==="running"?"运行中":"未运行"),1)],2)])])]),_:1}),c(v,{class:"stat-card"},{header:l(()=>[...t[16]||(t[16]=[e("div",{class:"card-header"},"最近查询时间",-1)])]),default:l(()=>[e("div",Yt,[e("div",Pt,x(I.value),1),e("div",Qt,"自动刷新倒计时："+x(gt.value),1)])]),_:1}),c(v,{class:"stat-card"},{header:l(()=>[...t[17]||(t[17]=[e("div",{class:"card-header"},"图表显示时间",-1)])]),default:l(()=>[e("div",Nt,[e("div",jt,[e("button",{class:M(["day-btn",{active:F.value===1}]),onClick:t[0]||(t[0]=s=>lt(1))}," 最近1天 ",2),e("button",{class:M(["day-btn",{active:F.value===7}]),onClick:t[1]||(t[1]=s=>lt(7))}," 最近一周 ",2)])])]),_:1}),c(v,{class:"stat-card"},{header:l(()=>[...t[18]||(t[18]=[e("div",{class:"card-header"},"其他",-1)])]),default:l(()=>[e("div",Jt,[c(i,{type:"info",class:"action-btn",onClick:St},{default:l(()=>[...t[19]||(t[19]=[e("span",{class:"btn-icon"},"📝",-1),b(" 更新日志 ",-1)])]),_:1}),c(i,{type:"success",class:"action-btn",onClick:bt},{default:l(()=>[...t[20]||(t[20]=[e("span",{class:"btn-icon"},"📥",-1),b(" 导出数据 ",-1)])]),_:1}),c(i,{type:"primary",class:"action-btn",onClick:pt},{default:l(()=>[...t[21]||(t[21]=[e("span",{class:"btn-icon"},"📋",-1),b(" 查看历史记录 ",-1)])]),_:1})])]),_:1})]),c(v,{class:"voltage-status-card"},{header:l(()=>[...t[22]||(t[22]=[e("div",{class:"voltage-status-header"},[e("span",{class:"voltage-status-title"},"设备实时电压状态"),e("span",{class:"voltage-status-subtitle"},"（绿色：运行中 | 灰色：停止）")],-1)])]),default:l(()=>[e("div",Gt,[(h(!0),y(j,null,J(tt.value,s=>(h(),y("div",{key:s.machine_name,class:M(["device-item",{running:s.isRunning,stopped:!s.isRunning}]),onClick:m=>Dt(s.machine_name)},[e("div",{class:M(["device-status-dot",{running:s.isRunning,stopped:!s.isRunning}])},null,2),e("div",Xt,x(s.machine_name),1),e("div",Zt,[e("span",te,x(s.voltage),1),t[23]||(t[23]=e("span",{class:"voltage-unit"},"mV",-1))])],10,Kt))),128))])]),_:1}),K.value?(h(),y("div",ee,[c(v,{class:"chart-card"},{header:l(()=>[...t[24]||(t[24]=[e("div",{class:"chart-title"},"总看板",-1)])]),default:l(()=>[c(Bt)]),_:1})])):q.value.length===0?(h(),y("div",ae,[c(v,{class:"no-data-card"},{default:l(()=>[...t[25]||(t[25]=[e("div",{class:"no-data"},"暂无数据",-1)])]),_:1})])):(h(),Ft(v,{key:2,class:"chart-card"},{header:l(()=>[...t[26]||(t[26]=[e("div",{class:"chart-title"},"所有设备电压平均值总览",-1)])]),default:l(()=>[...t[27]||(t[27]=[e("div",{id:"combined-chart",class:"chart-wrapper-large"},null,-1)])]),_:1})),c(u,{modelValue:B.value,"onUpdate:modelValue":t[3]||(t[3]=s=>B.value=s),title:"系统日志",width:"80%","close-on-click-modal":!1},{footer:l(()=>[e("div",oe,[c(i,{onClick:t[2]||(t[2]=s=>V.value=[])},{default:l(()=>[...t[28]||(t[28]=[b("清除日志",-1)])]),_:1}),c(i,{type:"primary",onClick:yt},{default:l(()=>[...t[29]||(t[29]=[b("关闭",-1)])]),_:1})])]),default:l(()=>[e("div",se,[e("div",{class:"logs-container",ref_key:"logsContainerRef",ref:U},[(h(!0),y(j,null,J(V.value,(s,m)=>(h(),y("div",{key:m,class:M(["log-line",{"log-error":s.includes("[错误]"),"log-warning":s.includes("[警告]"),"log-success":s.includes("[成功]")}])},x(s),3))),128))],512)])]),_:1},8,["modelValue"]),c(u,{modelValue:A.value,"onUpdate:modelValue":t[6]||(t[6]=s=>A.value=s),title:"导出数据",width:"500px","close-on-click-modal":!1},{footer:l(()=>[e("div",le,[c(i,{onClick:t[5]||(t[5]=s=>A.value=!1),disabled:R.value},{default:l(()=>[...t[31]||(t[31]=[b("取消",-1)])]),_:1},8,["disabled"]),c(i,{type:"primary",onClick:_t,loading:R.value},{default:l(()=>[b(x(R.value?"导出中...":"确认导出"),1)]),_:1},8,["loading"])])]),default:l(()=>[e("div",ne,[t[30]||(t[30]=e("div",{class:"date-range-label"},"选择时间范围",-1)),c(r,{modelValue:T.value,"onUpdate:modelValue":t[4]||(t[4]=s=>T.value=s),type:"datetimerange","range-separator":"至","start-placeholder":"起始时间","end-placeholder":"截止时间",format:"YYYY-MM-DD HH:mm:ss",style:{width:"90%"}},null,8,["modelValue"])])]),_:1},8,["modelValue"]),c(u,{modelValue:O.value,"onUpdate:modelValue":t[8]||(t[8]=s=>O.value=s),title:"更新日志",width:"700px","close-on-click-modal":!1},{footer:l(()=>[e("div",ve,[c(i,{type:"primary",onClick:t[7]||(t[7]=s=>O.value=!1)},{default:l(()=>[...t[33]||(t[33]=[b("关闭",-1)])]),_:1})])]),default:l(()=>[e("div",ie,[(h(),y(j,null,J(xt,(s,m)=>e("div",{key:m,class:"changelog-item"},[e("div",re,[e("div",de,x(s.version),1),e("div",ce,x(s.date),1)]),e("div",ue,[(h(!0),y(j,null,J(s.changes,(n,g)=>(h(),y("div",{key:g,class:"changelog-change"},[t[32]||(t[32]=e("span",{class:"changelog-icon"},"•",-1)),e("span",ge,x(n),1)]))),128))])])),64))])]),_:1},8,["modelValue"]),c(u,{modelValue:Y.value,"onUpdate:modelValue":t[10]||(t[10]=s=>Y.value=s),title:`${nt.value} 电压趋势图`,width:"85%","close-on-click-modal":!1,"align-center":"","destroy-on-close":"",top:"5vh"},{footer:l(()=>[e("div",me,[c(i,{type:"primary",onClick:t[9]||(t[9]=s=>Y.value=!1)},{default:l(()=>[...t[34]||(t[34]=[b("关闭",-1)])]),_:1})])]),default:l(()=>[t[35]||(t[35]=e("div",{class:"device-chart-container"},[e("div",{id:"device-detail-chart",class:"device-detail-chart"})],-1))]),_:1},8,["modelValue","title"])])}}}),we=Vt(pe,[["__scopeId","data-v-39208aca"]]);export{we as default};
